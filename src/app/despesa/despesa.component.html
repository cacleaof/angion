<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="navegarParaHome()" color="primary" aria-label="Voltar para Home">
        Home
      </ion-button>
    </ion-buttons>
    <ion-title>
      Todas as Despesas (ordenadas por vencimento)
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="recent-section">

    <ion-button
      expand="block"
      (click)="carregarDespesas()"
      [disabled]="loading"
      size="small"
      aria-label="Atualizar lista de despesas"
    >
      {{ loading ? 'Carregando...' : 'Atualizar' }}
    </ion-button>

    <div *ngIf="loading" class="loading">
      Carregando despesas...
    </div>

    <ion-list *ngIf="!loading && despesas.length > 0">
      <ion-item *ngFor="let despesa of despesas" [class.paga]="despesa.pago" (click)="abrirModal(despesa)">
        <ion-label>
          <h2>{{ despesa.nome }}</h2>
          <p *ngIf="despesa.descricao">{{ despesa.descricao }}</p>
          <p class="valor" [class.paga]="despesa.pago">Valor: R$ {{ despesa.valor }}</p>
          <p *ngIf="despesa.venc">Vencimento: {{ despesa.venc | date:'dd/MM/yyyy' }}</p>
          <p *ngIf="despesa.imagem && despesa.imagem !== ''" class="imagem">
            Imagem: {{ despesa.imagem }}
          </p>
          <p *ngIf="despesa.pago" class="status-pago">✓ Paga</p>
        </ion-label>

        <!-- Botões de ação -->
        <div slot="end" class="action-buttons" (click)="$event.stopPropagation()">
          <ion-button fill="clear" (click)="abrirModal(despesa)" color="primary" [attr.aria-label]="'Editar despesa ' + despesa.nome">
            Editar
          </ion-button>
          <ion-button fill="clear" (click)="deletarDespesa(despesa)" color="danger" [attr.aria-label]="'Deletar despesa ' + despesa.nome">
            Deletar
          </ion-button>
          <ion-button fill="clear" (click)="marcarComoPaga(despesa)" [color]="despesa.pago ? 'success' : 'warning'" [attr.aria-label]="'Marcar despesa ' + despesa.nome + ' como ' + (despesa.pago ? 'não paga' : 'paga')">
            {{ despesa.pago ? 'Paga' : 'Pagar' }}
          </ion-button>
        </div>
      </ion-item>
    </ion-list>

    <div *ngIf="!loading && despesas.length === 0" class="no-data">
      <p>Nenhuma despesa encontrada.</p>
    </div>
  </div>
</ion-content>

<!-- Modal para criar/editar despesa -->
<ion-modal [isOpen]="showModal" (didDismiss)="fecharModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>{{ editingDespesa ? 'Editar Despesa' : 'Nova Despesa' }}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="fecharModal()" aria-label="Cancelar">Cancelar</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding">
      <form (ngSubmit)="salvarDespesa()">
        <ion-input
          label="Nome da Despesa *"
          [(ngModel)]="novaDespesa.nome"
          name="nome"
          required
          placeholder="Digite o nome da despesa"
        ></ion-input>

        <ion-textarea
          label="Descrição"
          [(ngModel)]="novaDespesa.descricao"
          name="descricao"
          placeholder="Digite a descrição da despesa"
          rows="3"
        ></ion-textarea>

        <ion-input
          label="Valor *"
          [(ngModel)]="novaDespesa.valor"
          name="valor"
          type="number"
          step="0.01"
          required
          placeholder="Digite o valor"
        ></ion-input>

        <ion-input
          label="Data de Vencimento"
          [(ngModel)]="novaDespesa.venc"
          name="venc"
          type="date"
          placeholder="Selecione a data de vencimento"
        ></ion-input>

        <ion-input
          label="Imagem (URL)"
          [(ngModel)]="novaDespesa.imagem"
          name="imagem"
          placeholder="URL da imagem (opcional)"
        ></ion-input>

        <ion-button expand="block" type="submit" color="primary" [attr.aria-label]="editingDespesa ? 'Atualizar despesa' : 'Criar despesa'">
          {{ editingDespesa ? 'Atualizar' : 'Criar' }} Despesa
        </ion-button>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>
